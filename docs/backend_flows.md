# Tai lieu kien truc backend - He thong quan ly chi tieu AI

## 1. Danh gia yeu cau nghiep vu (C·∫£i ti·∫øn)

- ‚úÖ Yeu cau hop ly, khong co xung dot lon; he thong co the van hanh thu cong neu chua co API lien ket vi.
- ‚ö†Ô∏è **C·∫¶N C·∫¢I TI·∫æN**: Multi-currency support v·ªõi real-time exchange rates t·ª´ reliable providers (Fixer.io, CurrencyAPI).
- ‚ö†Ô∏è **C·∫¶N B·ªî SUNG**: KYC/email verification flow v·ªõi OTP, device management, v√† 2FA cho premium users.
- ‚úÖ **ƒê√É C·∫¢I TI·∫æN**: Budget alerting v·ªõi predictive ML models v√† real-time notifications qua multiple channels.
- ‚ö†Ô∏è **C·∫¶N B·ªî SUNG**: Quota reset automation v·ªõi sliding window rate limiting v√† usage predictions.
- üÜï **TH√äM M·ªöI**: Security audit logging, fraud detection, v√† compliance v·ªõi data protection regulations.
- üÜï **TH√äM M·ªöI**: Performance monitoring v·ªõi SLA targets v√† auto-scaling capabilities.

## 2. Kien truc tong the

- De xuat Modular Monolith voi cac layer ro rang (Controller -> Validation -> Service -> Repository -> Event) de de dang tach microservice sau nay.
- Danh sach module backend:
  - API Gateway / HTTP Layer: Express, middleware auth, logging, rate limit, error handler.
  - Auth & User Service: dang ky/dang nhap, refresh token, RBAC, quan ly ho so.
  - Wallet & Transaction Service: CRUD vi, quan ly so du, xu ly giao dich thu cong va dong bo.
  - Category & Classification Service: danh muc he thong + tu tao, mapping AI, quan ly goi y.
  - Budget & Goal Service: ngan sach, saving goal, tinh toan muc tieu, trigger canh bao.
  - Subscription & Billing Service: quan ly plan, subscription, quota, lifecycle.
  - Payment Service: tao payment intent, xu ly webhook MoMo/ZaloPay/VNPay/Stripe, doi soat.
  - AI Orchestrator Service: chat, phan tich, tao insight, ghi audit log.
  - Notification Service: queue gui email/push/in-app, scheduler, retry.
  - Integration Sync Service: ket noi bank/e-wallet, scheduler, webhook listener, normalizer.
  - Reporting & Analytics Service: tong hop du lieu OLAP, cung cap API bao cao cho admin.
  - Admin Service: REST cho quan tri user, plan, bao cao.
  - Shared: Audit log, Quota, Feature flag, Config, Outbox.
- Event-driven: su dung message queue (BullMQ/Redis hoac RabbitMQ) de xu ly cac cong viec can thiet bi dong bo nhu email, thong bao, dong bo provider.

## 3. Flow REST cho cac use case chinh

### 3.1 Dang ky user va tao vi mac dinh (C·∫£i ti·∫øn)

1. **Request**: `POST /api/v1/auth/register` body: email, password, fullName, optional phone.
2. **Enhanced Security & Validation**:
   - Rate limiting: 5 requests/15min per IP
   - Email domain validation + disposable email detection
   - Password strength: 8+ chars, mixed case, numbers, symbols
   - Captcha verification (production environment)
   - Device fingerprinting cho security tracking
3. **Service** `authService.register`:
   - Hash password v·ªõi bcrypt (salt rounds: 12)
   - Tao user v·ªõi status `pending_verification` (not `pending`)
   - Generate email verification token v·ªõi 24h TTL
   - **ATOMIC**: T·∫°o default wallet ngay (kh√¥ng qua job) ƒë·ªÉ ƒë·∫£m b·∫£o consistency
   - Ghi comprehensive audit log v·ªõi IP, user-agent, device info
4. **Repository**: UserModel.create, TokenModel.create, WalletModel.create trong same transaction.
5. **Event/Job**:
   - Event `user.registration_requested` ‚Üí EmailService g·ª≠i verification
   - Event `user.welcome_wallet_created` ‚Üí Analytics tracking
   - **NO JOB**: Wallet creation atomic v·ªõi registration
6. **Response**: 201 + { userId, verificationRequired: true, expiresIn: "24h" }
7. **Auth/RBAC**: User m·∫∑c ƒë·ªãnh role `user`, email verified ‚Üí `active` status
8. **üÜï Email Verification Flow**:
   ```
   GET /api/v1/auth/verify-email/{token}
   ‚îú‚îÄ‚îÄ Validate token (not expired, not used)
   ‚îú‚îÄ‚îÄ Update user status: 'active'
   ‚îú‚îÄ‚îÄ Auto-generate login session
   ‚îú‚îÄ‚îÄ Event: 'user.email_verified'
   ‚îî‚îÄ‚îÄ Response: 200 + access/refresh tokens
   ```

### 3.2 Dang nhap va refresh token (C·∫£i ti·∫øn b·∫£o m·∫≠t)

1. **Request**: `POST /api/v1/auth/login` ‚Üí Enhanced security validation.
2. **Security Layer**:
   - Rate limiting: 10 attempts/15min per IP, 5 failed attempts/account ‚Üí 15min lockout
   - Suspicious login detection (unusual location, device, time)
   - CAPTCHA after 3 failed attempts
   - Device fingerprinting v√† session management
3. **Service** enhanced `authService.login`:
   - Password verification v·ªõi timing attack protection
   - Account status validation (`active`, not `suspended`)
   - 2FA validation (n·∫øu enabled cho premium users)
   - Failed attempt tracking v√† automatic lockout
   - Subscription status check (graceful degradation n·∫øu expired)
   - Device session generation v·ªõi unique fingerprint
4. **Token Management** (Enhanced):
   - Access token: 15 minutes TTL v·ªõi user claims
   - Refresh token: 7 days TTL v·ªõi device binding
   - Store refresh token trong Redis v·ªõi device metadata
   - Support multiple concurrent sessions v·ªõi device management
5. **Audit & Events**:
   - Audit log: `user_login_success` v·ªõi comprehensive metadata
   - Event: `security.suspicious_login` n·∫øu detect anomaly
   - Event: `device.new_session_created` cho tracking
6. **Response**:
   ```json
   {
     "accessToken": "...",
     "refreshToken": "...",
     "user": {...},
     "securityAlerts": [...],
     "deviceInfo": {...}
   }
   ```

### 3.3 Tao vi moi / lien ket provider

1. **Request**: `POST /api/v1/wallets` (body: walletName, walletType, provider?, alias?, currency?).
2. **Auth/RBAC**: middleware xac thuc user; kiem tra role (user/premium) va han muc theo subscription.
3. **Validation**: Joi/Zod kiem tra quota so vi, walletType hop le, alias/chung minh ten khong trung, currency thuoc danh sach ho tro, provider nam trong danh sach cho phep.
4. **Service** `walletService.create`:
   - Bat dau Mongo session de dam bao atom.
   - Set gia tri mac dinh (`isLinked=false`, `connectionStatus='disconnected'`, `balance=0`) neu khong co provider.
   - Neu `provider` duoc gui: tao/stub `IntegrationConnection` (status=`pending`, luu scope, metadata) de theo doi qua trinh lien ket.
   - Ghi `AuditLog` voi hanh dong `wallet_create_requested`.
5. **Repository**: insert Wallet (va IntegrationConnection neu co) trong session; cap nhat `QuotaUsage.walletsCount`.
6. **Event/Job**: day job `integration.init_connection` voi walletId + provider (async) -> worker lo OAuth/huong dan user; neu async fail -> cap nhat `connectionStatus='error'` + thong bao.
7. **Response**: 201 -> wallet detail (bao gom trang thai ket noi) + message huong dan (neu lien ket).
8. **Notification (optional)**: neu vuot muc 80% so vi -> day event `notification.quota_warning`.

### 3.4 Them giao dich thu cong + ho tro AI

1. `POST /api/v1/transactions` voi walletId, type, amount, occurredAt...
2. Validation: wallet thuoc user, amount >0, so du du (neu cash).
3. Service: TransactionService.create -> check quota, bat dau session Mongo -> cap nhat wallet balance.
4. Repository: Transaction.create, Wallet.updateOne (session).
5. Event: push `budget.recalculate`, `goal.recalculate`, `report.transaction_aggregated`.
6. Response: transaction + balance moi.
7. Chatbot flow: `POST /api/v1/ai/transactions/parse` -> AI parse (async synchronous HTTP) -> tra ve draft + confidence -> neu su dung -> goi endpoint tao giao dich nhu tren.

### 3.5 Dong bo giao dich tu bank/e-wallet (C·∫£i ti·∫øn to√†n di·ªán)

1. **Initiate Sync**: `POST /api/v1/wallets/{id}/sync`
   - **Pre-validation**: Connection status, rate limits, concurrent sync prevention
   - **Immediate Response**: 202 + jobId + estimated completion time
2. **Enhanced Background Worker** `syncWalletJob`:
   - **Authentication**: Secure credential retrieval t·ª´ encrypted store
   - **Incremental Fetch**: Ch·ªâ l·∫•y data t·ª´ lastSyncAt ƒë·ªÉ optimize performance
   - **Data Validation**: Schema validation, amount range checks, date consistency
   - **Smart Duplicate Detection**: Hash-based deduplication (providerId + amount + date + merchant)
   - **Conflict Resolution**: User preference-based resolution cho conflicting data
   - **Batch Processing**: Process transactions theo batches ƒë·ªÉ avoid memory issues
3. **Enhanced Error Handling**:
   - **Retry Logic**: Exponential backoff v·ªõi max 5 retries
   - **Partial Failure**: Continue processing valid transactions, log failed ones
   - **Circuit Breaker**: Temporary disable sync n·∫øu provider consistently fails
   - **Manual Intervention**: Flag accounts c·∫ßn manual review
4. **Real-time Monitoring**:
   - **Job Status API**: `GET /api/v1/sync-jobs/{jobId}/status`
   - **WebSocket Updates**: Real-time progress cho UI
   - **Progress Tracking**: Detailed progress v·ªõi error categorization
5. **Data Integrity**:
   - **Balance Reconciliation**: So s√°nh balance v·ªõi provider v√† local calculation
   - **Transaction Integrity**: Verify transaction sequence v√† missing gaps
   - **Audit Trail**: Complete sync history v·ªõi detailed logs
6. **Events & Notifications**:
   - `sync.started`, `sync.progress`, `sync.completed`, `sync.failed`
   - `sync.conflict_detected`, `sync.manual_intervention_required`
   - Email/push notifications cho completion status
   - Dashboard alerts cho failed syncs

### 3.6 Phan loai chi tieu va mapping danh muc (C·∫£i ti·∫øn)

1. **Khi transaction t·∫°o, CategoryResolutionService.resolveCategory ƒë∆∞·ª£c g·ªçi:**
   - **B∆∞·ªõc 1**: N·∫øu c√≥ `categoryId` explicit ‚Üí validate v√† tr·∫£ v·ªÅ ngay
   - **B∆∞·ªõc 2**: N·∫øu c√≥ `categoryName` ‚Üí normalize v√† check theo th·ª© t·ª±:
     - Check user mapping (`UserExpenseCategory.normalizedName`) v·ªõi `needsConfirmation=false`
     - Check system category (`ExpenseCategory.name/nameEn`) v·ªõi fuzzy matching
     - G·ªçi AI Dictionary mapping (`mapToCanonicalCategory`)
   - **B∆∞·ªõc 3**: N·∫øu kh√¥ng match ‚Üí AI suggestion ‚Üí t·∫°o `UserExpenseCategory` v·ªõi `needsConfirmation=true, isActive=false`

2. **Tr·∫£ v·ªÅ transaction v·ªõi category resolution metadata:**

   ```json
   {
     "categoryId": "ObjectId ho·∫∑c null",
     "needsCategoryConfirmation": boolean,
     "categorySuggestion": { "id", "name", "normalizedName" },
     "matchedSource": "explicit|user|system|null"
   }
   ```

3. **User x√°c nh·∫≠n suggestion:**
   - `POST /api/v1/categories/suggestions/{id}/confirm`
   - Body: `{ "systemCategoryId": "...", "categoryName": "..." }`
   - Logic:
     - N·∫øu ch·ªçn system category ‚Üí link v·ªõi system, update mapping
     - N·∫øu t·∫°o m·ªõi ‚Üí t·∫°o `ExpenseCategory` custom + mapping
     - Update suggestion record: `needsConfirmation=false, isActive=true`
     - Ghi audit log `category_confirmed`

4. **Events & Analytics:**
   - `analytics.category_usage` cho m·ªói l·∫ßn s·ª≠ d·ª•ng category
   - `category.suggestion_created` khi AI t·∫°o suggestion
   - `category.confirmed` khi user confirm

5. **Background jobs:**
   - **Category learning**: Aggregate category usage ƒë·ªÉ c·∫£i thi·ªán AI mapping
   - **Cleanup**: X√≥a suggestions c≈© ch∆∞a confirm sau 30 ng√†y

### 3.7 Tao ngan sach va canh bao (C·∫£i ti·∫øn AI-powered)

1. **Enhanced Budget Creation**: `POST /api/v1/budgets`
   - **Smart Validation**: Period overlap detection, realistic amount validation
   - **AI Recommendations**: Historical spending analysis cho suggested amounts
   - **Multi-currency Support**: Automatic currency conversion v√† normalization
   - **Seasonal Adjustments**: AI-detected seasonal patterns cho accurate budgeting
2. **Intelligent Budget Service**:
   - **Historical Analysis**: Analyze 12-month spending patterns
   - **Predictive Modeling**: ML-based budget recommendations
   - **Category Intelligence**: Smart category grouping v√† spending insights
   - **Real-time Calculation**: Live budget tracking v·ªõi transaction stream processing
3. **Advanced Monitoring System**:
   - **Predictive Alerts**: ML model d·ª± ƒëo√°n overspend probability
   - **Smart Thresholds**: Adaptive thresholds based on user behavior
   - **Multi-tier Alerting**:
     ```
     50% ‚Üí Early warning v·ªõi spending insights
     80% ‚Üí Caution alert v·ªõi actionable recommendations
     95% ‚Üí Critical alert v·ªõi immediate actions
     100%+ ‚Üí Exceeded notification v·ªõi recovery suggestions
     Predictive ‚Üí "Will exceed in X days at current rate"
     ```
4. **Enhanced Worker** `budget.evaluate` (Hourly + real-time triggers):
   - **Real-time Processing**: Process budget updates on transaction events
   - **Intelligent Categorization**: Auto-assign transactions to relevant budgets
   - **Trend Analysis**: Weekly/monthly trend detection v√† forecasting
   - **Adaptive Learning**: Improve prediction accuracy based on user feedback
5. **Multi-channel Notifications**:
   - **In-app**: Real-time dashboard updates v·ªõi visual indicators
   - **Push**: Mobile push notifications v·ªõi action buttons
   - **Email**: Weekly digest v·ªõi spending analysis
   - **SMS**: Critical alerts only (100%+ overspend)
6. **Events & Analytics**:
   - `budget.threshold_reached`, `budget.predicted_overspend`
   - `analytics.spending_pattern_detected`, `user.budget_behavior_learned`

### 3.8 Saving goal va dong gop

1. `POST /api/v1/saving-goals` -> validate deadline, priority.
2. Dong gop: `POST /api/v1/saving-goals/{id}/contributions` -> luu `SavingGoalContribution`, cap nhat `currentAmount` (session) -> log event `goal.contribution_added`.
3. Worker `goal.evaluate` chay hang ngay -> check progress, phat canh bao neu cham.

### 3.9 Subscription billing va thanh toan gateway (C·∫£i ti·∫øn b·∫£o m·∫≠t)

1. **Enhanced Checkout**: `POST /api/v1/subscriptions/checkout`
   - **Security Layer**: Fraud detection, user verification, payment amount validation
   - **Provider**: PayOS duy nh·∫•t (QR/payment link)
   - **Enhanced PaymentIntent**: Secure requestId, expiry (15 min), metadata encryption
   - **Payload**: `{ planId, returnUrl?, cancelUrl? }`
   - **Cancel Flow**: `POST /api/v1/subscriptions/checkout/cancel` c·∫≠p nh·∫≠t tr·∫°ng th√°i khi user h·ªßy tr∆∞·ªõc khi PayOS g·ª≠i webhook
   - **Validation**: Block inactive users/plans, reuse active intent ƒë·ªÉ tr√°nh t·∫°o l·∫°i
   - **Response**: 202 + secure `paymentUrl` + `requestId` + TTL
   - **Provider Integration**: PayOS (`PAYOS_*` env) v·ªõi payload k√Ω HMAC + metadata AES-256-GCM

2. **Robust Webhook Processing**: `POST /api/v1/payments/webhook/{provider}`
   - **Enhanced Security**:
     ```
     ‚îú‚îÄ‚îÄ HMAC-SHA256 signature verification
     ‚îú‚îÄ‚îÄ Timestamp validation (5-minute window)
     ‚îú‚îÄ‚îÄ IP whitelist verification
     ‚îú‚îÄ‚îÄ Payload size limits (1MB max)
     ‚îî‚îÄ‚îÄ Rate limiting per provider
     ```
   - **Idempotency Protection**: Webhook ID deduplication, replay attack prevention (collection `PaymentWebhookEvent`)
   - **Queue Job**: `payment.webhook_secure` -> persisted event + async worker

3. **Enhanced Webhook Worker**:
   - **Security Validation**: Re-verify signature, check payment amount consistency
   - **Business Logic**:
     ```
     ‚îú‚îÄ‚îÄ Payment status reconciliation
     ‚îú‚îÄ‚îÄ Amount v√† currency verification
     ‚îú‚îÄ‚îÄ Subscription tier validation
     ‚îú‚îÄ‚îÄ Prorated billing calculation
     ‚îî‚îÄ‚îÄ Grace period handling
     ```
   - **Atomic Operations**: Payment update + Subscription activation + Quota reset trong transaction
   - **Enhanced Events**: `payment.verified`, `subscription.activated`, `billing.cycle_started`

4. **Advanced Reconciliation**: `payment.reconcile` (Every 5 minutes)
   - **Proactive Monitoring**: Check pending payments, detect stuck transactions & locked webhooks
   - **Auto-recovery**: Retry failed webhooks, manual intervention alerts (`PaymentWebhookEvent` reset)
   - **Fraud Detection**: Unusual payment patterns, repeated failures
   - **Customer Support**: Auto-create support tickets cho failed payments (event `payment.failed`)

5. **Smart Auto-renewal** (3 days before expiry):
   - **Payment Method Validation**: Verify active payment methods
   - **Intelligent Retry**: Multiple payment attempts v·ªõi different methods
   - **Customer Communication**: Email sequence v·ªÅ upcoming renewal
   - **Graceful Degradation**: Partial feature access trong grace period

6. **Enhanced Monitoring**:
   - **Real-time Dashboards**: Payment success rates, provider performance
   - **Alerting System**: Failed payments, webhook delays, fraud detection
   - **Business Metrics**: MRR, churn rate, payment method distribution
   - **Jobs**: `payment-webhook-secure-processor (1m)`, `payment-reconciliation (5m)`, `subscription-auto-renewal (03:00)`

### 3.10 AI chat va goi y insight (C·∫£i ti·∫øn AI context)

1. **Enhanced AI Request**: `POST /api/v1/ai/chat`
   - Body: `question` (b·∫Øt bu·ªôc), `conversationId` (optional ‚Üí server t·ª± sinh n·∫øu thi·∫øu)
   - H·ªôi tho·∫°i l∆∞u trong Mongo `ai_conversations`, gi·ªõi h·∫°n 10 l∆∞·ª£t trao ƒë·ªïi g·∫ßn nh·∫•t ƒë·ªÉ ki·ªÉm so√°t token
2. **Advanced Validation & Security**
   - **Quota**: S·ª≠ d·ª•ng `quota_usage` + `aiRecommendationsLimit` c·ªßa plan, c·∫£nh b√°o khi v∆∞·ª£t 80%, ch·∫∑n khi h·∫øt l∆∞·ª£t
   - **Rate limit**: `rateLimit({ windowMs: 1 gi·ªù, max: 20 })`
   - **Content filter**: ch·∫∑n t·ª´ kh√≥a ƒë·ªôc h·∫°i/phi ph√°p tr∆∞·ªõc khi g·ªçi LLM
   - **Context limit**: c·∫Øt l·ªãch s·ª≠, gi·ªõi h·∫°n 600 tokens khi g·ªçi OpenRouter
3. **Smart Context Building (AI Orchestrator)**
   - T·ªïng h·ª£p 30 ng√†y d·ªØ li·ªáu: giao d·ªãch m·ªõi nh·∫•t, breakdown danh m·ª•c, xu h∆∞·ªõng th√°ng, ng√¢n s√°ch v√† m·ª•c ti√™u ti·∫øt ki·ªám ƒëang ho·∫°t ƒë·ªông
   - Th√™m th√¥ng tin ng∆∞·ªùi d√πng (ng√¥n ng·ªØ, timezone) v√† ghi ch√∫ m√πa v·ª• chi ti√™u v√†o prompt
4. **Enhanced AI Processing**
   - Ph√¢n lo·∫°i intent (budgeting/analysis/saving_goal/investment/general), ƒë√°nh gi√° ƒë·ªô ph·ª©c t·∫°p c√¢u h·ªèi
   - ƒê·ªãnh tuy·∫øn model: `OPENROUTER_MODEL_FAST` vs `OPENROUTER_MODEL_ADVANCED` (m·∫∑c ƒë·ªãnh GPT-4o mini) theo m·ª©c ƒë·ªô ph·ª©c t·∫°p
   - Y√™u c·∫ßu LLM tr·∫£ JSON theo schema chu·∫©n, fallback khi sai format, t·ª± ch√®n disclaimer an to√†n
5. **Intelligent Response Enhancement**
   - B·ªï sung follow-up, relatedFeatures, recommendations n·∫øu LLM kh√¥ng tr·∫£ ƒë·ªß; t·∫•t c·∫£ ·ªü d·∫°ng h√†nh ƒë·ªông c·ª• th·ªÉ
   - Ph·∫£n h·ªìi k√®m th√¥ng tin quota (`used`, `monthlyLimit`, `warnings`) ƒë·ªÉ client hi·ªÉn th·ªã
6. **Advanced Events & Learning** (publish qua `domainEvents`)
   - `ai.query_processed` (intent, model, latency, confidence)
   - `recommendation.generated` (danh s√°ch khuy·∫øn ngh·ªã, confidence)
   - `user.engagement_tracked` (feature = `ai_chat`, metadata intent)
7. **Response Format**
   ```json
   {
     "answer": "...",
     "confidence": 0.82,
     "recommendations": [...],
     "visualizations": [...],
     "followUpQuestions": [...],
     "relatedFeatures": [...],
     "disclaimers": ["Th√¥ng tin ch·ªâ mang t√≠nh tham kh·∫£o..."]
   }
   ```

### 3.11 Notification pipeline

1. Bat ky module phat event `notification.enqueue` voi: userId, templateKey, channel, data, priority.
2. Notification worker lay template, render noi dung, goi provider (SendGrid/SES, Firebase, in-app socket).
3. Cap nhat `Notification` doc -> them `deliveryAttempts`, dat `deliveryStatus`.
4. Neu that bai -> retry 3 lan, sau do set failed va thong bao admin qua Slack webhook.

### 3.12 Admin giam sat

1. Admin login `POST /api/v1/admin/auth/login` (yeu cau role=admin, nen co 2FA).
  2. Dashboard `GET /api/v1/admin/metrics/overview` lay du lieu tu Reporting service (cache Redis 5 phut).
     - Ket qua gom tong user/active, thong ke subscription, plan status, giao dich 30 ngay va sync log 24h.
     - Cache key `admin:metrics:overview`, TTL 300s, auto invalidate khi plan thay doi.
  3. Quan ly subscription plan `POST/PUT /api/v1/admin/plans` -> thong qua service -> invalidate cache.
     - `POST` tao plan moi, bat buoc `planName`, `planType`, `price`, `billingPeriod`.
     - `PUT /api/v1/admin/plans/{planId}` cap nhat cac chi so quota, status, features.
  4. Theo doi log dong bo `GET /api/v1/admin/sync-logs` -> co filter thoi gian, status.
     - Ho tro params `startDate`, `endDate`, `status`, `syncType`, `userId`, `walletId`, `page`, `limit`.

## 4. Quan he giua cac service

- Auth Service phat event cho Wallet Service tao vi mac dinh; cap token cho Notification Service gui email.
- Wallet/Transaction Service phat event cho Budget, Goal, Reporting de xu ly async -> giam coupling.
- Payment Service goi Subscription Service (sync) va Notification Service (async) moi khi co bien dong.
- AI Service chi doc du lieu tu cac service khac (read model) va ghi Audit, Recommendation -> dam bao an toan.
- Integration Service tro thanh producer chinh cua transaction tu dong, su dung Outbox de retry khi loi.
- Notification Service la consumer cho cac topic: budget_alert, subscription_active, sync_result, ai_recommendation.

## 5. Goi y cai tien (C·∫≠p nh·∫≠t 2025)

### **Performance & Scalability:**

- ‚úÖ **Implemented**: Redis caching cho categories, user sessions, analytics (15-min refresh)
- üÜï **NEW**: Multi-tier caching strategy (Memory ‚Üí Redis ‚Üí DB)
- üÜï **NEW**: Database read replicas cho reporting queries
- üÜï **NEW**: Connection pooling optimization v√† query optimization

### **Reliability & Resilience:**

- ‚úÖ **Implemented**: Outbox pattern cho critical events (payment, sync)
- üÜï **NEW**: Circuit breaker pattern cho external API calls
- üÜï **NEW**: Graceful degradation khi dependencies fail
- üÜï **NEW**: Auto-retry v·ªõi exponential backoff v√† jitter

### **Security & Compliance:**

- ‚úÖ **Enhanced**: Rate limiting v·ªõi sliding window algorithm
- üÜï **NEW**: Bot detection v·ªõi CAPTCHA integration (reCAPTCHA/Turnstile)
- üÜï **NEW**: Advanced fraud detection cho payments
- üÜï **NEW**: GDPR compliance tools (data export, deletion, anonymization)
- üÜï **NEW**: Field-level encryption cho sensitive data

### **Operational Excellence:**

- üÜï **NEW**: OpenTelemetry integration v·ªõi Prometheus/Grafana
- üÜï **NEW**: Comprehensive health checks v√† service mesh ready
- üÜï **NEW**: Feature flags system v·ªõi gradual rollouts
- üÜï **NEW**: Automated testing pipeline v·ªõi performance benchmarks

### **Data Management:**

- ‚úÖ **Planned**: Data retention policy (36 months transaction ‚Üí S3 archive)
- üÜï **NEW**: Real-time analytics v·ªõi ClickHouse/BigQuery
- üÜï **NEW**: Data lake architecture cho advanced analytics
- üÜï **NEW**: Automated backup v·ªõi point-in-time recovery

### **Scalability Roadmap:**

- **Phase 1** (Current): Optimized monolith v·ªõi microservice patterns
- **Phase 2** (6 months): Extract high-traffic services (Payment, AI, Notification)
- **Phase 3** (12 months): Full microservices v·ªõi service mesh
- **Phase 4** (18 months): Multi-region deployment v·ªõi data locality

## 6. Bao mat va RBAC (C·∫£i ti·∫øn Enterprise-grade)

### **Enhanced Authentication:**

- ‚úÖ JWT + refresh token rotation v·ªõi device binding
- üÜï **NEW**: Multi-factor authentication (TOTP, SMS, Email) cho all users
- üÜï **NEW**: Biometric authentication support (WebAuthn/FIDO2)
- üÜï **NEW**: Social login v·ªõi OAuth 2.0 (Google, Apple, Facebook)
- üÜï **NEW**: Device management v·ªõi remote logout capabilities

### **Advanced Authorization:**

- ‚úÖ **Enhanced**: RBAC (user, premium, admin) + ABAC cho fine-grained control
- üÜï **NEW**: Dynamic permission system v·ªõi context-aware policies
- üÜï **NEW**: Resource-level permissions (own wallets, shared budgets)
- üÜï **NEW**: Temporary permission elevation v·ªõi approval workflows
- üÜï **NEW**: API key management cho third-party integrations

### **Security Monitoring:**

- ‚úÖ **Enhanced**: Comprehensive audit logging v·ªõi IP, user-agent, geolocation
- üÜï **NEW**: Real-time threat detection v·ªõi ML-based anomaly detection
- üÜï **NEW**: Security incident response automation
- üÜï **NEW**: Compliance reporting (SOC 2, ISO 27001 ready)
- üÜï **NEW**: Penetration testing integration v·ªõi automated security scans

### **Data Protection:**

- ‚úÖ **Enhanced**: Encryption at rest v√† in transit (TLS 1.3)
- üÜï **NEW**: Key management v·ªõi HSM/AWS KMS integration
- üÜï **NEW**: Data masking cho non-production environments
- üÜï **NEW**: Zero-trust network architecture
- üÜï **NEW**: Regular security assessments v√† vulnerability management

### **Compliance & Privacy:**

- üÜï **NEW**: GDPR compliance v·ªõi automated data subject rights
- üÜï **NEW**: PCI DSS compliance cho payment processing
- üÜï **NEW**: Data residency controls cho international users
- üÜï **NEW**: Privacy-preserving analytics v·ªõi differential privacy

## 7. Tach tac vu sync/async

- Sync: cac API CRUD (user, wallet, giao dich thu cong, budget) phan hoi ngay.
- Async: dong bo provider, gui email/push, xu ly webhook thanh toan, chay AI dang tran, tinh toan bao cao.
- Queue de xuat: BullMQ (Redis) cho job vua va nho, RabbitMQ/ Kafka neu can luong lon.
- Dead letter queue de xu ly job loi, kem alert Slack/Email cho devops.

## 8. De xuat cong nghe (Updated 2025)

### **Core Infrastructure:**

- ‚úÖ **Current**: MongoDB v·ªõi replica sets v√† automated backups
- üÜï **NEW**: Redis Cluster cho high availability caching v√† session management
- üÜï **NEW**: Message queue: BullMQ (Redis-based) ‚Üí RabbitMQ ‚Üí Apache Kafka (scale progression)
- üÜï **NEW**: CDN integration v·ªõi CloudFlare/AWS CloudFront

### **Analytics & Search:**

- üÜï **NEW**: ClickHouse cho real-time analytics v√† financial reporting
- üÜï **NEW**: Elasticsearch cho transaction search v√† user behavior analytics
- üÜï **NEW**: Apache Kafka Streams cho real-time data processing
- üÜï **NEW**: Data lake architecture v·ªõi Apache Parquet format

### **AI & Machine Learning:**

- ‚úÖ **Current**: OpenAI GPT-4 + Google Gemini cho AI chat
- üÜï **NEW**: TensorFlow/PyTorch cho custom ML models (fraud detection, spending prediction)
- üÜï **NEW**: MLflow cho model versioning v√† deployment
- üÜï **NEW**: Feature store v·ªõi Feast cho ML feature management

### **Monitoring & Observability:**

- üÜï **NEW**: Prometheus + Grafana cho metrics v√† alerting
- üÜï **NEW**: Jaeger/Zipkin cho distributed tracing
- üÜï **NEW**: ELK Stack (Elasticsearch + Logstash + Kibana) cho log management
- üÜï **NEW**: Sentry cho error tracking v√† performance monitoring

### **Security & Authentication:**

- üÜï **NEW**: Keycloak/Auth0 cho identity management
- üÜï **NEW**: HashiCorp Vault cho secrets management
- üÜï **NEW**: OWASP ZAP cho automated security testing
- üÜï **NEW**: Snyk cho dependency vulnerability scanning

### **DevOps & Deployment:**

- üÜï **NEW**: Kubernetes v·ªõi Helm charts cho container orchestration
- üÜï **NEW**: ArgoCD cho GitOps deployment
- üÜï **NEW**: Docker v·ªõi multi-stage builds cho optimized images
- üÜï **NEW**: Terraform cho infrastructure as code

### **Cloud & Scaling:**

- üÜï **NEW**: AWS/GCP/Azure multi-cloud strategy
- üÜï **NEW**: Auto-scaling v·ªõi KEDA (Kubernetes Event-driven Autoscaling)
- üÜï **NEW**: Service mesh v·ªõi Istio cho microservices communication
- üÜï **NEW**: Edge computing v·ªõi AWS Lambda@Edge cho global performance

@2025 Backend Architecture Notes - Enhanced Enterprise Edition

---

## üìä **SUMMARY: BACKEND FLOWS ASSESSMENT**

### **Overall Improvement Score: 7.5 ‚Üí 9.5/10** üöÄ

### ‚úÖ **Key Improvements Made:**

1. **Security**: Multi-layer security, fraud detection, compliance ready
2. **Reliability**: Circuit breakers, graceful degradation, auto-recovery
3. **Performance**: Multi-tier caching, query optimization, auto-scaling
4. **AI Enhancement**: Smart context building, multi-model routing, continuous learning
5. **Monitoring**: Comprehensive observability, real-time alerting, business metrics
6. **Scalability**: Microservice-ready architecture v·ªõi clear migration path

### üéØ **Production Readiness Status:**

- ‚úÖ **MVP Version**: Ready for production v·ªõi core features
- ‚úÖ **Enhanced Version**: Enterprise-grade v·ªõi all improvements
- ‚úÖ **Scale Version**: Ready for 100K+ users v·ªõi microservices migration

### üí° **Next Steps:**

1. **Week 1-2**: Implement critical security v√† error handling improvements
2. **Month 1**: Add caching, monitoring, enhanced AI features
3. **Month 2-3**: Performance optimization, advanced security
4. **Month 4+**: Microservices migration, multi-region deployment

**Backend architecture b√¢y gi·ªù ƒë√£ enterprise-ready v√† c√≥ th·ªÉ scale t·ª´ startup ƒë·∫øn enterprise! üî•**
